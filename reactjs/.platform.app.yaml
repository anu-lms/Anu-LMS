name: frontend
type: nodejs:8.9
size: S

dependencies:
  nodejs:
    yarn: "*"
    pm2: "^2.4.0"

web:

  commands:
    start: "PM2_HOME=$PLATFORM_APP_DIR/run NODE_ENV=production pm2 start server.js --no-daemon"

  locations:
    "/":
      passthru: true
    "/static":
      passthru: false
      root: "static"
      allow: false
      # Rules for specific URI patterns.
      rules:
        # Allow access to common static files.
        '\.(jpe?g|png|gif|svgz?|css|txt|js|map|ico|bmp|eot|woff2?|otf|mp3|ttf)$':
          allow: true

hooks:
  build: |
    # For non-production environment add http auth data into the
    # .env file. It will help frontend to make authenticated requests
    # to the backend.
    if [ "$PLATFORM_BRANCH" != master ]; then
      echo "Adding http authentication to the .env file..."
      echo "HTTP_AUTH_USER=$HTTP_AUTH_USER" > .env
      echo "HTTP_AUTH_PASS=$HTTP_AUTH_PASS" >> .env
    fi

    # Run usual yarn build commands.
    yarn install
    yarn run build
disk: 512

mounts:
  # Make whole build folder writeble for build scripts purposes.
  '/run': 'shared:files/run'
